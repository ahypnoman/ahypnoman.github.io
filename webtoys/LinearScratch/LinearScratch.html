<!--<!DOCTYPE html>-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Linear Scratch</title>
    <link rel="stylesheet" href="editor.css">
    <link rel="stylesheet" href="popups.css">
    <script src="BlockMotion.js"></script>
    <script src="interpreter.js"></script>
    <script src="popups.js"></script>
</head>
<body>
<div class="mainContent">
    <button class="roundButton" style="--button-icon: url('icons/Undo.svg'); --button-content: 'Undo'; position:fixed; top: 5px; left: 5px;" onclick="loadUndoRedo(false)" tabindex="1"></button>
    <button class="roundButton" style="--button-icon: url('icons/Redo.svg'); --button-content: 'Redo'; position:fixed; top: 5px; left: 70px;" onclick="loadUndoRedo(true)" tabindex="2"></button>
    <button class="roundButton" style="--button-icon: url('icons/Options.svg'); --button-content: 'Options'; position:fixed; top: calc(50% + 65px); right: 5px;" onclick="renderSettings()" tabindex="6"></button>
    <button class="roundButton" style="--button-icon: url('icons/Help_blue.svg'); --button-content: 'Help'; position:fixed; top: calc(50% + 65px); right: 70px;" onclick="renderHelp()" tabindex="7"></button>
    <button class="roundButton playButton" style="display: none; --button-icon: url('icons/Play.svg'); --button-content: 'Play'; position:fixed; bottom: calc(50vh + 5px); left: 5px;"></button>
    <!--<span id="helper" style="left: 0; top: 50%; z-index: 10000000000000001; position: fixed; background: red; display: inline-block; height: 1px; width: 200%; transform: translate(0, -50%)"></span>-->
    <div class="blockHolder"></div>
    <span class="measurements"></span>
    <div class="codeMenu">
        <svg class="pattern">
            <defs>
                <pattern id="grid" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                    <line stroke="#ddd" stroke-width="2" x1="13.162500000000001" y1="13.8375" x2="14.512500000000001"
                          y2="13.8375"></line>
                    <line stroke="#ddd" stroke-width="2" x1="13.8375" y1="13.162500000000001" x2="13.8375"
                          y2="14.512500000000001"></line>
                </pattern>
            </defs>
            <rect x="0" y="0" width="100%" height="100%" fill="url(#grid)"></rect>
        </svg>
        <span class="scriptWrapperOuter">
            <span class="nameWrapper">
                <button style="background-color: #ffffff" class="plainButton" onclick="popups.editScript(editing)" tabindex="3"><img alt="Options" class="scriptOptionsButton" src="icons/Options_small.svg" width="14"></button>
                <span class="scriptNameWrapper">
                        <input placeholder="Name script" class="scriptName resize" oninput="resizeCheck(this); get(projectInfo, editing).name = this.value; treeRender(); saveToHistory()" type="text" value="Main" tabindex="4">
                </span>
            </span>
            <span class="loopsWrapper"></span>
            <span class="errorsWrapper"></span>
            <span class="scriptWrapper"><span class="start"><span style="width: 100%; height: 100%; border: 1px solid #ffffff; position: absolute; border-radius: 20px 0 0 20px"></span><img width="20" src="icons/script/Script_start.svg">Start<span class="snapPoint snapPointStart"></span></span><span class="end"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><img width="20" src="icons/script/Script_end.svg">end</span></span>
            <button class="roundButton" style="--button-icon: url('icons/Back.svg'); --button-content: 'Back'; position:absolute; top: 50%; right: calc(-95px); transform: translate(-50%, -50%)" onclick="document.getElementsByClassName('codeMenu')[0].scrollTo({top:(document.getElementsByClassName('codeMenu')[0].scrollHeight - document.body.scrollHeight/2)/2,left:0,behavior:'smooth'})" tabindex="5"></button>
        </span>
        <span style=" left: -1px;" class="scrollHelper"></span>
        <span style=" right: -1px;" class="scrollHelper"></span>
    </div>

    <div class="codeMenuWrapper">
        <div class="treeWrapper">
            <input class="name" oninput="projectInfo.projectMeta.name = [...this.value].join(''); saveToHistory()">
            <br>
            <div class="tree"></div>
        </div>
        <div class="codeMenuContent">
            <div class="sectionsWrapper">
                <button class="section" onclick="paletteScrollTo('pointer')"><span class="sectionCircle" style="background: #4d97ff" ></span>Pointer</button><button class="section" onclick="paletteScrollTo('memory')"><span class="sectionCircle" style="background: #ff8c19"></span>Memory</button><button class="section" onclick="paletteScrollTo('interaction')"><span class="sectionCircle" style="background: #4cbfe6"></span>Interaction</button><button class="section"onclick="paletteScrollTo('control')"><span class="sectionCircle" style="background: #ffac16"></span>Control</button>
            </div>
            <div class="paletteHolderOuter">
                <div class="paletteHolder">
                </div>
            </div>
        </div>
    </div>
</div>
<div class="whiteBG beforeLoad"><noscript><span class='warning'>Your browser has not permitted use of Javascript. Please enable Javascript or switch to another browser.</span></noscript><img src="LSimages/LS_logo.svg" style="width: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)"></div>
<script>

    let projectInfo = {}

    const blockInfo = {
        '>':['#4d97ff','Next cell'],
        '<':['#4d97ff','Last cell'],
        '+':['#ff8c19','Increase value in cell'],
        '-':['#ff8c19','Decrease value in cell'],
        '.':['#4cbfe6','Output cell value'],
        ',':['#4cbfe6','Get input'],
        '[':['#ffac16','Open loop'],
        ']':['#ffac16','Close loop']
    }

    let editing = "projectData.main"

    newProject()

    let sessionInfo = {
        closedWarnings: [],
        fullHistory:[],
        undoRedoHistory:[],
        undoRedoPos:0,
        saveTo:""
    }

    function loadUndoRedo(redoing) {
        if (redoing && sessionInfo.undoRedoPos!==sessionInfo.undoRedoHistory.length-1){
            sessionInfo.undoRedoPos++
        } else if (!redoing && sessionInfo.undoRedoPos!==0){
            sessionInfo.undoRedoPos--
        }
        projectInfo = sessionInfo.undoRedoHistory[sessionInfo.undoRedoPos]
        renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code);
        treeRender()
        playButtonCheck()
        if (document.getElementsByClassName("settingsIdentifier")[0]){
            renderProjectManager()
            renderProjectHistory()
            document.getElementsByClassName("description")[0].value = projectInfo.projectMeta.description
            document.getElementsByClassName("presetInputs")[0].value = projectInfo.projectMeta.settings.inputs
            highlightButton(document.getElementsByClassName("defaultInputType")[0].children[(projectInfo.projectMeta.settings.defaultInput==="ASCII")?0:1])
            highlightButton(document.getElementsByClassName("defaultDisplayType")[0].children[(projectInfo.projectMeta.settings.defaultDisplay==="ASCII")?0:(projectInfo.projectMeta.settings.defaultDisplay==="Numeric")?1:2])
        }
    }

    function saveToHistory() {
        sessionInfo.undoRedoHistory.slice(0, sessionInfo.undoRedoPos)
        sessionInfo.undoRedoPos = sessionInfo.undoRedoHistory.length
        if (!JSON.stringify(sessionInfo.fullHistory[sessionInfo.fullHistory.length-1]) || JSON.stringify(sessionInfo.fullHistory[sessionInfo.fullHistory.length-1].data) !== JSON.stringify(projectInfo)) {
            sessionInfo.fullHistory.push({
                time: new Date(),
                data: JSON.parse(JSON.stringify(projectInfo))
            })
            sessionInfo.undoRedoHistory.push(JSON.parse(JSON.stringify(projectInfo)))
        }
        if (storageAvailable())createOrEditSaveSlot(sessionInfo.saveTo,projectInfo)
    }

        function newProject() {
        projectInfo = genProject()
    }

    function genProject() {
        return {
            version: 'v2',
            projectData: {
                main: {
                    icon: "",
                    name: "Main",
                    code: ""
                },
                custom: {
                    name: "Custom blocks",
                    color: '#ff6680',
                    scripts: []
                },
                extensions: {},
                scripts: {}
            },
            projectMeta: {
                name: "",
                description: "",
                settings: {
                    defaultDisplay: "ASCII",
                    defaultInput: "ASCII",
                    cellWrap: [],
                    inputs: [],
                }
            }
        }
    }

    function renderWarning(value, ignoreClosed){
        if(!ignoreClosed && !sessionInfo.closedWarnings.includes(value)){
            document.body.insertAdjacentHTML("beforeend", `<span class='warning' style='--warning-content: "${value}"'><button onclick="this.parentElement.remove()"></button></span>`)
            sessionInfo.closedWarnings.push(value)
        } else if(ignoreClosed){
            document.body.insertAdjacentHTML("beforeend", `<span class='warning' style='--warning-content: "${value}"'><button onclick="this.parentElement.remove()"></button></span>`)
        }
    }

    identifyBlocks()

    function saveScript(path, code) {
        let generatedCode = ""
        code.shift()
        code.pop()
        code.forEach((i)=>{
            generatedCode += "‡" + i
        })
        get(projectInfo, path).code = generatedCode
    }

    function renderScript(title,code,loc) {
         if(!loc) {
             const wrapper = document.getElementsByClassName('scriptWrapper')[0]
             if(editing==="projectData.main") wrapper.innerHTML = '<span class="start"><span style="width: 100%; height: 100%; border: 1px solid #ffffff; position: absolute; border-radius: 20px 0 0 20px"></span><img width="20" src="icons/script/Script_start.svg">Start<span class="snapPoint snapPointStart"></span></span>';
             else wrapper.innerHTML = '<span class="start custom"><span style="width: 100%; height: 100%; border: 1px solid #ffffff; position: absolute; border-radius: 20px 0 0 20px"></span><span style="font-size: 50px">{</span>Define<span class="snapPoint snapPointStart"></span></span>'
             const codeList = code.split("‡")
             codeList.shift()
             codeList.forEach((i) => {
                 const isBf = ['>', '<', '+', '-', '.', ',', '[', ']'].includes(i)
                 console.log(projectInfo.projectData.scripts[i], i)
                 wrapper.insertAdjacentHTML('beforeend', `<span class="block" blockType="${(isBf) ? 'BF' : projectInfo.projectData.scripts[i].loc}" blockcode="${i}" style="--block-color:${(isBf) ? blockInfo[i][0] : ((projectInfo.projectData.scripts[i].loc === 'projectData.custom') ? '#ff6680' : get(projectInfo, projectInfo.projectData.scripts[i].loc).color)};"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">${(isBf) ? i : projectInfo.projectData.scripts[i].icon}</span><br>${(isBf) ? blockInfo[i][1] : projectInfo.projectData.scripts[i].name}</span></span><span class="snapPoint"></span></span>`)
             })
             if(editing==="projectData.main") wrapper.insertAdjacentHTML('beforeend', '<span class="end"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><img width="20" src="icons/script/Script_end.svg">End</span>');
             else wrapper.insertAdjacentHTML('beforeend', '<span class="end custom"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span style="font-size: 50px">}</span>Define</span>')
             const scriptName = document.getElementsByClassName('scriptName')[0]
             if(scriptName){
                 scriptName.value = title
                 resizeCheck(scriptName)
             }
         } else {
             loc.innerHTML = '<span class="start"><span style="width: 100%; height: 100%; border: 1px solid #ffffff; position: absolute; border-radius: 20px 0 0 20px"></span><img width="20" src="icons/script/Script_start.svg">Start<span class="snapPoint snapPointStart"></span></span>'
             const codeList = code.split("‡")
             codeList.shift()
             codeList.forEach((i) => {
                 const isBf = ['>', '<', '+', '-', '.', ',', '[', ']'].includes(i)
                 loc.insertAdjacentHTML('beforeend', `<span class="block" blockType="${(isBf) ? 'BF' : projectInfo.projectData.scripts[i].loc}" blockcode="${i}" style="--block-color:${(isBf) ? blockInfo[i][0] : ((projectInfo.projectData.scripts[i].loc === 'projectData.custom') ? '#ff6680' : get(projectInfo, projectInfo.projectData.scripts[i].loc).color)};"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">${(isBf) ? i : projectInfo.projectData.scripts[i].icon}</span><br>${(isBf) ? blockInfo[i][1] : projectInfo.projectData.scripts[i].name}</span></span><span class="snapPoint"></span></span>`)
             })
             loc.insertAdjacentHTML('beforeend', '<span class="end"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><img width="20" src="icons/script/Script_end.svg">end</span>')
         }
         identifyBlocks(true)
         loopAndErrorRender(loopAndErrorCheck(code.split("‡")).loops,loopAndErrorCheck(code.split("‡")).errors)
    }

    function treeRender() {
        document.getElementsByClassName("name")[0].value = projectInfo.projectMeta.name
        let customBlocks = ""
        projectInfo.projectData.custom.scripts.forEach((i)=>{
            customBlocks += `
                <button class="treeItem" onclick="editing = 'projectData.scripts.${i}'; renderScript('${projectInfo.projectData.scripts[i].name}', '${projectInfo.projectData.scripts[i].code}');">
                    <div class="treeIcon"><img alt="" src="icons/Code_normal.svg" width="30"></div>
                    <span class="treeBottomLevel">${projectInfo.projectData.scripts[i].name}</span>
                </button>
            `
        })
        let extensions = ""

        Object.keys(projectInfo.projectData.extensions).forEach((ti)=>{
            let extensionBlocks = ""
            projectInfo.projectData.extensions[ti].scripts.forEach((i)=>{
                extensionBlocks += `
                <button class="treeItem" onclick="editing = 'projectData.scripts.${i}'; renderScript('${projectInfo.projectData.scripts[i].name}', '${projectInfo.projectData.scripts[i].code}');">
                    <div class="treeIcon"><img alt="" src="icons/Code_normal.svg" width="30"></div>
                    <span class="treeBottomLevel">${projectInfo.projectData.scripts[i].name}</span>
                </button>
            `
            })

            extensions += `
                <button class="treeItem topLevel" onclick="popups.editExtension('projectData.extensions.${ti}')">
                    <div class="treeIcon" style="background: ${projectInfo.projectData.extensions[ti].color}"><img alt="" src="icons/Collection.svg" width="30"></div>
                    <span>${projectInfo.projectData.extensions[ti].name}</span>
                </button>
                ${extensionBlocks}
                <button class="treeItem addFile" onclick="popups.newScript('projectData.extensions.${ti}')">
                    <div class="treeIcon"><img alt="" src="icons/Add_extension_grey.svg" width="30"></div>
                    Add file
                </button>
            `
        })

        const tree = document.getElementsByClassName("tree")[0]
        tree.innerHTML = `<button class="treeItem" onclick="editing = 'projectData.main'; renderScript(projectInfo.projectData.main.name, projectInfo.projectData.main.code);"><div class="treeIcon"><img alt="" src="icons/Code_normal.svg" width="30"></div>${projectInfo.projectData.main.name}</button><div class="customBlocksContainer"><button class="treeItem topLevel" onclick="popups.editExtension('projectData.custom')"><div class="treeIcon" style="background: #ff6680"><img alt="" src="icons/Collection.svg" width="30"></div>Custom blocks</button>${customBlocks}<button class="treeItem addFile" onclick="popups.newScript('projectData.custom')"><div class="treeIcon"><img alt="" src="icons/Add_extension_grey.svg" width="30"></div>
                    Add file
                </button>
            </div>${extensions}<button class="treeItem topLevel addEx" onclick="popups.newExtension()">
                <div class="treeIcon" style="background: #15bc8c"><img alt="" src="icons/Add_extension_grey.svg" width="30"></div>
                Add extension
            </button>
            <div style="height: 100%; position: absolute; top: 0; left: 39px; border: #E6E6E6 solid; border-width: 0 1px 0 0;">
            </div>`;
            const width = tree.scrollWidth + 'px';
            [...document.getElementsByClassName('treeItem')].forEach((el) => {
                el.style.width = width
            })

        paletteRender()
    }

    function paletteRender() {
        let paletteSections = '<span class="newStart"></span><div class="paletteScriptWrapper" sectionName="pointer"> <div class="paletteScriptOuter"><div class="sectionName">Pointer<span class="sectionCircleSmall" style="background: #4d97ff"></span></div><div class="paletteScript"> <span class="start fake">{</span><span class="block fake" style="--block-color:#4d97ff" blockType="BF" blockCode=">"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">></span><br>Next cell</span></span></span><span class="block fake" style="--block-color:#4d97ff" blockType="BF" blockCode="<"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol"><</span><br>Last cell</span></span></span><span class="end fake"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span>}</span></div></div></div><div class="paletteScriptWrapper" sectionName="memory"><div class="paletteScriptOuter"><div class="sectionName">Memory<span class="sectionCircleSmall" style="background: #ff8c19"></span></div><div class="paletteScript"><span class="start fake">{</span><span class="block fake" style="--block-color:#ff8c19" blockType="BF" blockCode="+"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">+</span><br>Increase value in cell</span></span></span><span class="block fake" style="--block-color:#ff8c19" blockType="BF" blockCode="-"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">-</span><br>Decrease value in cell</span></span></span><span class="end fake"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span>}</span></div></div></div><div class="paletteScriptWrapper" sectionName="interaction"><div class="paletteScriptOuter"><div class="sectionName">Interaction<span class="sectionCircleSmall" style="background: #4cbfe6" ></span></div><div class="paletteScript"><span class="start fake">{</span><span class="block fake" style="--block-color:#4cbfe6" blockType="BF" blockCode="."><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">.</span><br>Output cell value</span></span></span><span class="block fake" style="--block-color:#4cbfe6" blockType="BF" blockCode=","><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">,</span><br>Get input</span></span></span><span class="end fake"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span>}</span></div></div></div><div class="paletteScriptWrapper" sectionName="control"><div class="paletteScriptOuter"><div class="sectionName">Control<span class="sectionCircleSmall" style="background: #ffac16"></span></div><div class="paletteScript"> <span class="start fake">{</span><span class="block fake" style="--block-color:#ffac16" blockType="BF" blockCode="["><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">[</span><br>Open loop</span></span></span><span class="block fake" style="--block-color:#ffac16" blockType="BF" blockCode="]"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">]</span><br>Close loop</span></span></span><span class="end fake"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span>}</span></div></div></div>'
        if (projectInfo.projectData.custom.scripts.length > 0) {
            paletteSections += '<div class="paletteScriptWrapper" sectionName="custom"><div class="paletteScriptOuter"><div class="sectionName">Custom blocks<span class="sectionCircleSmall" style="background: #ff6680"></span></div><div class="paletteScript"><span class="start fake">{</span>'
            projectInfo.projectData.custom.scripts.forEach((i) => {
                paletteSections += `<span class="block fake" style="--block-color:#ff6680" blockType="Custom" blockCode="${i}"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">${projectInfo.projectData.scripts[i].icon}</span><br>${projectInfo.projectData.scripts[i].name}</span></span></span>`
            })
            paletteSections += '<span class="end fake"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span>}</span></div></div></div>'
        }
        Object.keys(projectInfo.projectData.extensions).forEach((ti) => {
            paletteSections += `<div class="paletteScriptWrapper" sectionName="${ti}"><div class="paletteScriptOuter"><div class="sectionName">${projectInfo.projectData.extensions[ti].name}<span class="sectionCircleSmall" style="background: ${projectInfo.projectData.extensions[ti].color}"></span></div><div class="paletteScript"><span class="start fake">{</span>`
                projectInfo.projectData.extensions[ti].scripts.forEach((i) => {
                paletteSections += `<span class="block fake" style="--block-color:${projectInfo.projectData.extensions[ti].color}" blockType="Custom" blockCode="${i}"><span class="blockTop"></span><span class="blockBottom"></span><span class="innerBlock"><span class="centered"><span class="blockSymbol">${projectInfo.projectData.scripts[i].icon}</span><br>${projectInfo.projectData.scripts[i].name}</span></span></span>`
            })
            paletteSections += '<span class="end fake"><span class="blockTop" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span><span class="blockBottom" style="border-width: 0 0 0 1px; height: calc(50% - 7px);"></span>}</span></div></div></div>'
        })
        const paletteHolder = document.getElementsByClassName('paletteHolder')[0]
        paletteHolder.innerHTML += paletteSections
        while (!paletteHolder.children[0].classList.contains('newStart')) {
            paletteHolder.children[0].remove()
        }
        paletteHolder.children[0].remove()
        paletteSections = '<span class="newStart"></span><button class="section" onclick="paletteScrollTo(\'pointer\')"><span class="sectionCircle" style="background: #4d97ff"></span>Pointer</button><button class="section" onclick="paletteScrollTo(\'memory\')"><span class="sectionCircle" style="background: #ff8c19"></span>Memory</button><button class="section" onclick="paletteScrollTo(\'interaction\')"><span class="sectionCircle" style="background: #4cbfe6"></span>Interaction</button><button class="section" onclick="paletteScrollTo(\'control\')"><span class="sectionCircle" style="background: #ffac16"></span>Control</button>'
        if (projectInfo.projectData.custom.scripts.length > 0) {
            paletteSections += '<button class="section" onclick="paletteScrollTo(\'custom\')"><span class="sectionCircle" style="background: #ff6680"></span>Custom blocks</button>'
        }
        Object.keys(projectInfo.projectData.extensions).forEach((i) => {
            paletteSections += `<button class="section" onclick="paletteScrollTo('${i}')"><span class="sectionCircle" style="background: ${projectInfo.projectData.extensions[i].color}"></span>${projectInfo.projectData.extensions[i].name}</button>`
        })
        const sectionsWrapper = document.getElementsByClassName('sectionsWrapper')[0]
        sectionsWrapper.innerHTML += paletteSections
        while (!sectionsWrapper.children[0].classList.contains('newStart')) {
            sectionsWrapper.children[0].remove()
        }
        sectionsWrapper.children[0].remove()
        paletteScrollSizing()
        identifyBlocks(true)
    }

    function paletteScrollTo(section){
        const sectEl = document.querySelector(`[sectionName = ${section}]`)
        document.getElementsByClassName('paletteHolder')[0].scrollTo({left: 0, top: 123 + sectEl.offsetTop - parseInt(window.getComputedStyle(sectEl.parentElement).paddingTop)*2, behavior:'smooth'});
    }

    function resizeCheck(el){
        if(el.value !== "") {
            document.getElementsByClassName("measurements")[0].innerText = el.value
        } else {
            document.getElementsByClassName("measurements")[0].innerText = el.placeholder
        }
        el.style.width = (document.getElementsByClassName("measurements")[0].getBoundingClientRect().width+2) + "px"
    }

    [...document.getElementsByClassName("resize")].forEach((el)=>{resizeCheck(el)})

    function get(obj, path) {
        return path.split(".").reduce((acc,current)=>(acc)[current], obj)
    }

    function set(obj, path, val) {
        const keys = path.split(".")
        const keyLen = keys.length - 1
        for(let i = 0; i<keyLen; i++){
            obj = obj[keys[i]]
        }
        obj[keys[keyLen]] = val
    }

    function doResizePattern() {
        const code = document.getElementsByClassName("codeMenu")[0]
        document.getElementsByClassName("pattern")[0].style.width = "0px"
        document.getElementsByClassName("pattern")[0].style.height = "0px"
        document.getElementsByClassName("pattern")[0].style.width = code.scrollWidth - 1 + "px"
        document.getElementsByClassName("pattern")[0].style.height = code.scrollHeight - 1 + "px"
        treeRender()
        if(document.getElementsByClassName("debugScriptWrapperHolder")[0])renderUpdates(true)
    }

    function paletteScrollSizing() {
        const holder = document.getElementsByClassName("paletteHolder")[0]
        const hb = holder.getBoundingClientRect()
        const holderCenter = hb.y + hb.height / 2

        function doScroll() {
            const blockContainers = [...document.getElementsByClassName("paletteScriptWrapper")]
            blockContainers.forEach((el) => {
                const eb = el.getBoundingClientRect()
                const elDist = eb.y + eb.height / 2 - holderCenter
                const elChildren = [...el.children]
                elChildren.forEach((ch) => {
                    ch.style.opacity = 210 - Math.abs(elDist * 1.2) + "%"
                    ch.style.transformOrigin = "left"
                    ch.style.transform = "scale(" + ((300 - Math.abs(elDist)) / 300) + ")"
                })
            })
        }

        doScroll()
        holder.addEventListener("scroll", () => {
            doScroll()
        })
    }

    paletteScrollSizing()
    new ResizeObserver(paletteScrollSizing).observe(document.body);

    function parseFromHtml(){
        let codeArray = []
        let codeString = ""
        const scriptWrapper = [...document.getElementsByClassName("scriptWrapper")[0].children]
        scriptWrapper.forEach((el)=>{
            codeArray.push(el.getAttribute("blockCode"))
            codeString += "‡" + el.getAttribute("blockCode")
        })
        return {"array": codeArray, "string": codeString}
    }

    function loopAndErrorCheck(code) {
        let errors = []
        let loops = []
        let openLoops = 0
        for(let i = 0; i < code.length; i++){
            if(code[i] === "["){
                openLoops++
                let highestLevel = 1
                let checkLoops = 1
                let findOpeningIndex = i
                while(checkLoops>0&&findOpeningIndex<code.length){
                    findOpeningIndex++
                    if(code[findOpeningIndex] === "["){
                        checkLoops++
                        if(checkLoops > highestLevel) highestLevel = checkLoops
                    }else if(code[findOpeningIndex] === "]"){
                        checkLoops--
                    }
                }
                if(findOpeningIndex===code.length){
                    errors.push([i,"Loop does not close"])
                }else{
                    loops.push([i, findOpeningIndex, highestLevel])
                }
            }else if(code[i] === "]"){
                openLoops--
                let checkLoops = 1
                let findOpeningIndex = i
                while(checkLoops>0&&findOpeningIndex>-1){
                    findOpeningIndex--
                    if(code[findOpeningIndex] === "]"){
                        checkLoops++
                    }else if(code[findOpeningIndex] === "["){
                        checkLoops--
                    }
                }
                if(findOpeningIndex===-1)errors.push([i,"Loop does not open"])
            }
        }
        return {"loops": loops,"errors": errors}
    }

    function loopAndErrorRender(loops, errors){
        const loopsWrappers = [...document.getElementsByClassName("loopsWrapper")]
        const errorsWrapper = document.getElementsByClassName("errorsWrapper")[0]
        errorsWrapper.innerHTML = ""
        errors.forEach((er) => {
            errorsWrapper.insertAdjacentHTML("beforeend", `<span class="error" style="left:${(er[0] - 1) * 169 + 63}px;"><span class="errorTop"></span><span class="errorBottom" style="--error: '${er[1]}'"></span></span>`)
        })
        let greatestHeight = 0
        loopsWrappers.forEach((loopsWrapper)=> {
            loopsWrapper.insertAdjacentHTML("beforeend", "<span class='oldNewDivide'></span>")
            loops.forEach((l) => {
                if (l[2] > greatestHeight) greatestHeight = l[2]
                loopsWrapper.insertAdjacentHTML("beforeend", `<span class="loop" style="left: ${l[0] * 169 - 23}px; width: ${(l[1] - l[0]) * 169}px; height: ${l[2] * 20 + 104}px; border-radius: ${l[2] * 20 + 104}px"></span>`)
                const wrapperChildren = [...document.getElementsByClassName("scriptWrapper")[0].children]
                if (wrapperChildren[l[0]].classList.contains("silhouette") || wrapperChildren[l[1]].classList.contains("silhouette")) {
                    loopsWrapper.children[loopsWrapper.children.length - 1].style.backgroundColor = "#0d0d0d"
                    loopsWrapper.children[loopsWrapper.children.length - 1].style.opacity = "0.2"
                }
            })
        })
        const codeMenu = [...document.getElementsByClassName("codeMenu")][0]
        document.getElementById("grid").setAttribute("y", (greatestHeight*10).toString() + "px")
        codeMenu.scrollTop = (greatestHeight * 10)
        document.getElementsByClassName("scriptWrapperOuter")[0].setAttribute("style",`height: ${greatestHeight * 20 + 104 + "px"}; margin-top: ${"calc(25vh + " + (greatestHeight * 20) + "px - 54px)"};`)
        codeMenu.scrollTop = (greatestHeight * 10)
        let prevSibling = document.getElementsByClassName("oldNewDivide")[0].previousElementSibling
        while(prevSibling){
            prevSibling.remove()
            prevSibling = document.getElementsByClassName("oldNewDivide")[0].previousElementSibling
        }
        document.getElementsByClassName("oldNewDivide")[0].remove()
    }

    function genRandomString(){
        return (Math.random() + 1).toString(36).substring(2);
    }

    function createScript(loc, name, symbol, code){
        const id = '_' + genRandomString()
        console.log(loc)
        get(projectInfo, loc + '.scripts').push(id)
        console.log("create with id",id)
        projectInfo.projectData.scripts[id] = {icon: symbol.replace(/(\r\n|\n|\r)/gm, ""), name: name.replace(/(\r\n|\n|\r)/gm, ""), code: code?code.replace(/(\r\n|\n|\r)/gm, ""):"", loc: loc}
        editing = 'projectData.scripts.' + id
        renderScript(name,'')
        paletteRender()
        return id
    }

    function createExtension(name, color){
        const id = '_' + genRandomString()
        projectInfo.projectData.extensions[id] = {name: name.replace(/(\r\n|\n|\r)/gm, ""), color: color.replace(/(\r\n|\n|\r)/gm, ""), scripts: []}
        treeRender()
        paletteRender()
        return id
    }

    function doFullErrorsCheck(){
        let toReturn = true
        if(loopAndErrorCheck(projectInfo.projectData.main.code.split('‡')).errors.length>0){toReturn = false}
        Object.keys(projectInfo.projectData.scripts).forEach((i)=>{
            if (loopAndErrorCheck(projectInfo.projectData.scripts[i].code.split('‡')).errors.length > 0) {
                toReturn = false
            }
        })
        return toReturn
    }

    setInterval(()=> {
        if(document.getElementsByClassName("dragging").length > 0){
            [...document.getElementsByClassName("scrollHelper")].forEach((el)=>{
                el.style.display = "inline-block"
            })
            document.querySelectorAll(".scrollHelper:hover").forEach((el) => {
            const code = document.getElementsByClassName("codeMenu")[0]
            if (el.style.left === -1 + "px") {
                code.scrollLeft -= 3
            }else{
                code.scrollLeft += 3
            }
        })}else{
            [...document.getElementsByClassName("scrollHelper")].forEach((el)=>{
                el.style.display = "none"
            })
        }
    }, 10)

    let interpreterInfo = {
        turbo: false,
        paused: true,
        requestInput: false
    }

    function renderTurbo() {
        if (interpreterInfo.turbo) {
            const turboButton = document.getElementsByClassName("turboButton")[0]
            turboButton.style.setProperty("--button-icon", "url('icons/Turbo_on.svg')")
            turboButton.style.color = "#ff8c1a"
        } else {
            const turboButton = document.getElementsByClassName("turboButton")[0]
            turboButton.style.setProperty("--button-icon", "url('icons/Turbo_off.svg')")
            turboButton.style.color = "#ffcd9c"
        }
    }
    
    function addNameInput(){
        document.getElementsByClassName('scriptNameWrapper')[0].innerHTML = `<input placeholder='Name script' class='scriptName resize' oninput='resizeCheck(this); get(projectInfo, editing).name = this.value; treeRender();' type='text' value='${get(projectInfo, editing).name}' >`
    }

    function renderMemDisplay(){
        let display = ""
        for(let i = (document.body.clientWidth/70 + 2)/2; i > 1; i--){
            display += "<span class='memBlock'>" + (runningInfo.range[0]||0) + "</span>"
        }
        runningInfo.memory.forEach((i)=>{
            display += `<span class='memBlock'>${i}</span>`
        })
        for(let i = (document.body.clientWidth/70 + 2)/2; i > 1; i--){
            display += "<span class='memBlock'>" + (runningInfo.range[0]||0) + "</span>"
        }
        return display
    }

    function startProgram() {
        if (document.getElementsByClassName("debugContent")[0]) {
            document.getElementsByClassName("startButton")[0].insertAdjacentHTML("afterend", `
        <span class="runningButtonsHolder">
        <button class="roundButton" style="--button-icon: url('icons/Stop.svg'); --button-content: 'Stop'; position:fixed; top: 5px; left: 70px" onclick="interpreterInfo.paused = true; this.parentElement.insertAdjacentHTML('afterend', startButton()); this.parentElement.remove()"></button>
        <button class="roundButton" style="--button-icon: url('icons/Pause.svg'); --button-content: 'Pause'; position:fixed; top: 5px; left: 135px" onclick="interpreterInfo.paused = !interpreterInfo.paused; if(interpreterInfo.paused){this.setAttribute('style',\`--button-icon: url('icons/Unpause.svg'); --button-content: 'Run'; position:fixed; top: 5px; left: 135px\`)}else{this.setAttribute('style',\`--button-icon: url('icons/Pause.svg'); --button-content: 'Pause'; position:fixed; top: 5px; left: 135px\`); interpretNext()}"></button>
        </span>
        `)
        } else {
            document.getElementsByClassName("startButton")[0].insertAdjacentHTML("afterend", `
        <span><button class="plainButton projectControl hasTip" onclick="interpreterInfo.paused = true; if(document.getElementsByClassName('inputPrompt')[0]) document.getElementsByClassName('inputPrompt')[0].remove(); document.getElementsByClassName('projectControls')[0].insertAdjacentHTML('beforeend', '<button class=\\'plainButton hasTip projectControl startButton\\' tip=\\'Play\\' onclick=\\'runProgram()\\'><img height=20 src=icons/Play.svg></button>'); this.parentElement.remove()" tip="Stop"><img width="20" height="20" src="icons/Stop.svg"></button>
        <button class="plainButton projectControl hasTip" onclick="interpreterInfo.paused = !interpreterInfo.paused; if(interpreterInfo.paused){this.setAttribute('tip','Unpause'); this.children[0].src = 'icons/Unpause_small.svg'}else{this.setAttribute('tip','Pause'); this.children[0].src = 'icons/Pause.svg'; interpretNext()}" tip="Pause"><img width="20" height="20" style="object-fit: fill" src="icons/Pause.svg"></button>
        </span>`)
        }
        document.getElementsByClassName("startButton")[0].remove()
        renderUpdates(true)
        interpretNext()
    }

    function startButton(){
        return `<button class="roundButton startButton" style="--button-icon: url('icons/Play.svg'); --button-content: 'Play'; position:fixed; top: 5px; left: 70px;" onclick="initialise(projectInfo.projectData.main.code, projectInfo.projectMeta.settings.inputs, projectInfo.projectMeta.settings.cellWrap, projectInfo.projectMeta.settings.defaultInput, document.getElementsByClassName('mBSelected')[0] ? document.getElementsByClassName('mBSelected')[0].textContent : projectInfo.projectMeta.settings.defaultDisplay); interpreterInfo.paused = false; startProgram();"></button>`
    }

    function renderOutputContent(mode){
        const el = document.getElementsByClassName("playerContent")[0]
        if(["ASCII","Numeric"].includes(mode)){
            let toSet = ""
            for(let i = 0; i < Math.min(runningInfo.output.length, 10000); i++){
                toSet += (mode === "ASCII") ? runningInfo.output[i]<128?String.fromCharCode(runningInfo.output[i]) : '#' : ' ' + runningInfo.output[i] + ' |'
            }
            if(mode === "Numeric") toSet = toSet.substring(0,toSet.length-1).trim();
            el.innerText = toSet
        } else if(mode === "Image"){
            const context = el.getContext("2d")
            for(let y = 0; y < Math.floor(runningInfo.output.length/1440); y++){
                for (let x = 0; x < 480; x++) {
                    const lineY = y
                    context.fillStyle = `rgb(${runningInfo.output[(x + lineY * 480) * 3 - 2]}, ${runningInfo.output[(x + lineY * 480) * 3 - 1]}, ${runningInfo.output[(x + lineY * 480) * 3]})`
                    context.fillRect(x, lineY%274, 1, 1)
                }
            }
            for(let x = 0; x < runningInfo.output.length%480; x++){
                const lineY = Math.floor(runningInfo.output.length/1440)
                context.fillStyle = `rgb(${runningInfo.output[(x + lineY * 480) * 3 - 2]}, ${runningInfo.output[(x + lineY * 480) * 3 - 1]}, ${runningInfo.output[(x + lineY * 480) * 3]})`
                context.fillRect(x, lineY%274, 1, 1)
            }
        }
    }

    function renderDebugContent(mode) {
        if(mode !== "debugger"){
            document.getElementsByClassName("debugContent")[0].innerHTML = `
            ${(mode === "Image") ? '<canvas class="playerContent" width="480" height="274"></canvas>' : '<div class="playerContentOuter"><div class="playerContent"></div></div>'}
            <div class="modeButtonsWrapper">
            <button class="modeButton ${(mode === "ASCII") ? "mBSelected": ""}" onmouseup="renderDebugContent('ASCII'); runningInfo.outputMode = 'ASCII'">ASCII</button>
            <button class="modeButton ${(mode === "Numeric") ? "mBSelected": ""}" onmouseup="renderDebugContent('Numeric'); runningInfo.outputMode = 'Numeric'">Numeric</button>
            <button class="modeButton ${(mode === "Image") ? "mBSelected": ""}" onmouseup="renderDebugContent('Image'); runningInfo.outputMode = 'Image'">Image</button>
            </div>
            <button class="roundButton" style="--button-icon: url('icons/Download_blue.svg'); --button-content: 'Export'; position:fixed; bottom: 65px; right: 5px;" onclick="popups.exportOutput()"></button>`
            renderOutputContent(mode)
        } else {
            document.getElementsByClassName("debugContent")[0].innerHTML = `
            <div class="debugScriptWrapperHolder"><span class="loopsWrapper" style="position: relative; left: calc(50% - 31.5px)"></span><div class="debugScriptWrapper" tabindex="-1"></div></div>
            <div class="memoryTitle">Memory</div>
            <div class="memDisplayBg"></div>
            <div class="memDisplayWrapper" tabindex="-1">${renderMemDisplay()}</div>`
            renderScript(projectInfo.projectData.main.name, projectInfo.projectData.main.code, document.getElementsByClassName('debugScriptWrapper')[0])
            document.getElementsByClassName('debugScriptWrapperHolder')[0].scrollLeft = 115
            renderUpdates(true)
            loopAndErrorRender(loopAndErrorCheck(projectInfo.projectData.main.code.split("‡")).loops, loopAndErrorCheck(projectInfo.projectData.main.code.split("‡")).errors)
        }
    }

    function renderDebug() {
        openViewTS();
        runProgram(true);
        if(document.getElementsByClassName("scriptName")[0])document.getElementsByClassName("scriptName")[0].remove()
        document.getElementsByClassName("mainContent")[0].insertAdjacentHTML('beforeend',`
        <div class="whiteBG">
        <button class="roundButton" style="--button-icon: url('icons/Close_blue.svg'); --button-content: 'Close'; position:fixed; top: 5px; left: 5px;" onclick="closeViewTS(); interpreterInfo.paused = true; addNameInput(); identifyBlocks(); resizeCheck(document.getElementsByClassName('scriptName')[0]); this.parentElement.remove()"></button>
        ${startButton()}
        <button class="roundButton" style="--button-icon: url('icons/Mode.svg'); --button-content: 'Mode'; position:fixed; top: 5px; right: 5px;" onclick="if(!document.getElementsByClassName('debugScriptWrapperHolder')[0]){renderDebugContent('debugger')} else {renderDebugContent(projectInfo.projectMeta.settings.defaultDisplay)}"></button>
        <button class="roundButton turboButton" style="--button-icon: url('icons/Turbo_on.svg'); --button-content: 'Turbo'; position:fixed; top: 5px; right: 70px;" onclick="interpreterInfo.turbo = !interpreterInfo.turbo; renderTurbo()"></button>
        <div class="viewTitle" style="border: none">Running project</div>
        <div class="debugContent"></div>
        </div>
        `)
        renderDebugContent("debugger")
        renderTurbo()
    }

    function createDownloadLinkFromList(list,noNewlines) {
        let link = "data:,"
        let acc = ""
        list.forEach((i)=>{
            acc+=i + (!noNewlines ? "\n" : "")
        })
        link+=encodeURIComponent(acc)
        return link
    }

    function highlightButton(target){
        [...target.parentElement.children].forEach((el)=>{el.style.backgroundColor = '#4d97ff'}); target.style.backgroundColor = '#3d79cc';
    }
    function importProjectFromV1(rawData) {
        let data = rawData.split("™")
        newProject()
        projectInfo.name = data[0]
        projectInfo.projectMeta.settings.defaultDisplay = data[1]
        projectInfo.projectMeta.description = data[2]
        projectInfo.projectData.main.icon = data[3].split("±")[0]
        projectInfo.projectData.main.name = data[3].split("±")[1]
        projectInfo.projectData.main.code = data[3].split("±")[2]
        for(let ti = 5; data[ti]!=="::" && data[ti]; ti++){
            projectInfo.projectData.scripts["_" + genRandomString()] = {
                icon: data[ti].split("±")[0].substring(1),
                name: data[ti].split("±")[1],
                code: data[ti].split("±")[2],
                loc: "projectData.custom"
            }
            projectInfo.projectData.custom.scripts.push(Object.keys(projectInfo.projectData.scripts)[Object.keys(projectInfo.projectData.scripts).length-1])
        }
        if(data.includes("::")) {
            indexOfAll(data,"::").forEach((i)=>{
                data = data.slice(data.indexOf("::")+1)
                let extension = data.slice(0, data.indexOf("::") ? data.indexOf("::") : data.length-1)
                projectInfo.projectData.extensions["_" + genRandomString()] = {
                    name: extension[0],
                    color: extension[1],
                    scripts: []
                }
                let exID = Object.keys(projectInfo.projectData.extensions)[Object.keys(projectInfo.projectData.extensions).length-1]
                extension = extension.slice(2)
                extension.forEach(()=> {
                    projectInfo.projectData.scripts["_" + genRandomString()] = {
                        icon: data[3].split("±")[0].substring(1),
                        name: data[3].split("±")[1],
                        code: data[3].split("±")[2],
                        loc: "projectData." + exID
                    }
                    get(projectInfo, "projectData.extensions." + exID).scripts.push(Object.keys(projectInfo.projectData.scripts)[Object.keys(projectInfo.projectData.scripts).length-1])
                })
            })
        }
    }

    function indexOfAll(array, val) {
        let allOccurrences = []
        array.forEach((i,ix)=>{
            if(i === val) allOccurrences.push(ix)
        })
        return allOccurrences
    }

    function IsJSON(str) {
        try {
            return (typeof JSON.parse(str) === 'object');
        } catch (e) {
            return false;
        }
    }

    function getFile() {
        return document.getElementsByClassName("import")[0].files[0]
    }

    function scrollToHeader(text){
        document.getElementById("textView-" + text).scrollIntoView({behavior: "smooth"})
    }

    function storageAvailable() {
        try{
            window.localStorage.setItem("availabilityTest","success :D")
            window.localStorage.removeItem("availabilityTest")
            return true
        } catch (err) {
            return false
        }
    }

    function openDropdown(items, el, note, func) {
        try{
            document.getElementsByClassName("dropdown")[0].remove()
        } catch (err) {
            let wrapper = document.createElement("div")
            wrapper.classList.add("dropdownWrapper")
            let dropdown = document.createElement("div")
            dropdown.classList.add("dropdown")
            dropdown.style.top = (el.getBoundingClientRect().top + el.getBoundingClientRect().height - 3) + "px"
            dropdown.style.left = el.getBoundingClientRect().left + "px"
            dropdown.style.width = el.getBoundingClientRect().width + "px"
            dropdown.style.visibility = "hidden"
            dropdown.innerHTML += `<div style="text-align: center; border-bottom: #e6e6e6 1px solid; padding-bottom: 10px">${note? `${note}` : "Select one"}</div><ul class="linkList"></ul>`
            // dropdown.style.borderRadius = "0 0 3px 3px"
            items.forEach((i) => {
                let dropdownItem = document.createElement("li")
                let dropdownItemContent = document.createElement("button")
                dropdownItemContent.classList.add("dropdownItem","plainButton")
                dropdownItemContent.innerText = i
                dropdownItemContent.addEventListener("click",()=>{
                    el.firstElementChild.innerText = i
                    func(dropdownItemContent)
                    wrapper.remove()
                })
                dropdownItem.appendChild(dropdownItemContent)
                dropdown.lastElementChild.appendChild(dropdownItem)
            })
            wrapper.appendChild(dropdown)
            document.body.appendChild(wrapper)
            wrapper.addEventListener("click",(e)=>{
                if(e.target===wrapper) wrapper.remove()
            })
            if (dropdown.getBoundingClientRect().bottom > window.innerHeight) {
                dropdown.style.top = (el.getBoundingClientRect().top - dropdown.getBoundingClientRect().height + 3) + "px"
                // dropdown.style.borderRadius = "3px 3px 0 0"
                if (dropdown.getBoundingClientRect().top < 10) {
                    dropdown.style.height = (dropdown.getBoundingClientRect().height - Math.abs(dropdown.getBoundingClientRect().top - 10)) + "px"
                    dropdown.style.top = (el.getBoundingClientRect().top - dropdown.getBoundingClientRect().height + 3) + "px"
                }
            }
            dropdown.style.visibility = "visible"
        }
    }

    //I entirely forgot that JSON.stringify() can convert lists into strings here. I'm not concerned with load time for this, so I won't change it.

    function createOrEditSaveSlot(name, data) {
        let store = JSON.parse(localStorage.getItem("ls-projectStore"))
        if(data){
            store[name] = data
        } else {
            store[name] = genProject()
        }
        localStorage.setItem("ls-projectStore", JSON.stringify(store))
        sessionInfo.saveTo = name
        localStorage.setItem("ls-settings", JSON.stringify({"autosave":JSON.parse(localStorage.getItem("ls-settings")).autosave,"openProject":name}))
        let list = JSON.parse(localStorage.getItem("ls-projectOrder"))
        if(!list.includes(name)) list.push(name)
        localStorage.setItem("ls-projectOrder",JSON.stringify(list))
    }

    function renameSaveSlot(slot,newName) {
        let projects = JSON.parse(localStorage.getItem('ls-projectStore'))
        delete Object.assign(projects, {[newName]: projects[slot] })[slot];
        localStorage.setItem("ls-projectStore",JSON.stringify(projects))
        let list = JSON.parse(localStorage.getItem('ls-projectOrder'))
        list[list.indexOf(slot)] = newName
        localStorage.setItem("ls-projectOrder",JSON.stringify(list))
        if(sessionInfo.saveTo === slot) {
            sessionInfo.saveTo = newName
            localStorage.setItem("ls-settings", JSON.stringify({"autosave":"true","openProject":newName}))
        }
    }

    function deleteSaveSlot(slot) {
        
        let projects = JSON.parse(localStorage.getItem('ls-projectStore'));
        delete projects[slot]
        localStorage.setItem("ls-projectStore",JSON.stringify(projects))
        let list = JSON.parse(localStorage.getItem('ls-projectOrder'))
        list.splice(list.indexOf(slot),1)
        localStorage.setItem("ls-projectOrder",JSON.stringify(list))
       if(sessionInfo.saveTo === slot) {
           sessionInfo.saveTo = list[list.length - 1]
           localStorage.setItem("ls-settings", JSON.stringify({"autosave":"true","openProject":list[list.length - 1]}))
       }
    }

    function openSaveSlot(slot) {
        sessionInfo.saveTo = slot
        localStorage.setItem("ls-settings", JSON.stringify({"autosave":"true","openProject":slot}))

    }

    function renderSettings() {
        openViewTS();
        [...document.getElementsByClassName("block")].forEach((el)=>{
            el.remove()
        })
        document.getElementsByClassName("scriptName")[0].remove()
        const displayMode = projectInfo.projectMeta.settings.defaultDisplay
        const inputMode = projectInfo.projectMeta.settings.defaultInput
        document.body.insertAdjacentHTML('beforeend',`
        <div class="whiteBG settingsIdentifier">
        <button class="roundButton" style="--button-icon: url('icons/Close_blue.svg'); --button-content: 'Close'; position:fixed; top: 5px; left: 5px;" onclick="closeViewTS(); addNameInput(); treeRender(); renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code); resizeCheck(document.getElementsByClassName('scriptName')[0]); this.parentElement.remove()"></button>
        <div class="viewTitle">Project options</div>
        <span class="viewSideBar">Linear Scratch is a programming language based off an esoteric programming language created by Urban Müller in 1993. The original language did not support functions, extensions, and other such features, although this compiles code into the original language as it runs. :D</span>
        <span class="settingsSideBar">
        <div class="sideBarSection" style="margin-top: 10px">
        <ul class="linkList">
        <li><button onclick="scrollToHeader('file')">File</button></li>
        <li><button onclick="scrollToHeader('project')">Project</button></li>
        <li><button onclick="scrollToHeader('export')">Export</button></li>
        </ul>
        </div>
        <div class="sideBarSection"><h1 class="sectionHeader">Project manager</h1>
        <div class="projectManager"></div>
        </div>
        <div class="sideBarSection"><h1 class="sectionHeader hasTip" tip="Project history is local and is not saved between tabs.">Project history</h1>
        Time<br>
        <ul class="projectHistory infoContainer linkList"></ul>
        </div>
        <div class="sideBarSection"><h1 class="sectionHeader">Your projects</h1>
        ${!storageAvailable() ? `<div>Sorry, your client does not support or has not permitted use of the localStorage API. Project storage requires this API to function.</div>` : `
        <ul class="userProjects infoContainer linkList"></ul><br>
        Generate session saves: <button class="toggle" onclick="toggleAutosaves(this)"></button><br>
        <!--<div class="normalInput saveSlotSelector" style="width: 100%; background-color: #ffffff; cursor: pointer; position: relative; box-sizing: border-box" onclick='openDropdown(Object.keys(JSON.parse(localStorage.getItem("ls-projectStore"))), this, "Select save slot",(el)=>{sessionInfo.saveTo = el.innerText; localStorage.setItem("ls-settings", JSON.stringify({"autosave":"true","openProject":el.innerText})); renderUserProjects(); saveToHistory()})'><div style="white-space: nowrap; overflow:scroll; max-width: calc(100% - 18.5px)">\${sessionInfo.saveTo}</div><div class="dropdownIcon"></div></div>-->
        `}
        </div>
        </span>
        <span class="settingsViewContent">
        <h1 class="sectionHeader" id="textView-file">File</h1>
        <button class="rectButton${projectInfo.projectData.main.code !== '' ? '" style="background-color: #4d97ff; color: #ffffff" onclick="this.parentElement.parentElement.remove(); renderPlayer()"' : ' inactive"'}>Play project<img height="27.5" style="height: 27.5px; width: min-content; padding: 0; float: right; margin: 0" src="icons/settings/Hollow_play.svg"></button>
        <button class="rectButton" style="background-color: #4d97ff; color: #ffffff" onclick="if(storageAvailable()) {popups.newSaveSlot(true)} else {newProject(); projectInfo.projectMeta.name = 'My Project'; editing = 'projectData.main'; addNameInput(); treeRender(); renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code); resizeCheck(document.getElementsByClassName('scriptName')[0]); document.getElementsByClassName('whiteBG')[0].remove()}">Create new project<img height="27.5" style="height: 27.5px; width: min-content; padding: 0; float: right; margin: 0" src="icons/settings/Plus.svg"></button>
        <button class="rectButton" style="background-color: #4d97ff; color: #ffffff" onclick="popups.importFile()">Import project<img height="27.5" style="height: 27.5px; width: min-content; padding: 0; float: right; margin: 0" src="icons/settings/Swap.svg"></button>
        <h1 class="sectionHeader" id="textView-project">Project</h1>
        <div class="settingsSectionWrapper">
        <span class="hasTip" tip="Sets the default output mode for your project:\n • Numeric displays raw numbers that your project outputs directly.\n • ASCII converts numbers into text (Search for &#34ASCII table&#34 for conversions).\n • Image takes every 3 inputs and uses them as an RGB values in an image of dimensions 480 by 274.">Default display type</span>
        <div class="defaultDisplayType" style="grid: 1fr / repeat(3, 1fr);"><button class="rectButton" style="background-color: ${displayMode === 'ASCII' ? '#3d79cc' : '#4d97ff'}; color: #ffffff" onclick="projectInfo.projectMeta.settings.defaultDisplay = 'ASCII'; saveToHistory(); highlightButton(this);">ASCII</button><button class="rectButton" style="background-color: ${displayMode === 'Numeric' ? '#3d79cc' : '#4d97ff'}; color: #ffffff" onclick="projectInfo.projectMeta.settings.defaultDisplay = 'Numeric'; saveToHistory(); highlightButton(this);">Numeric</button><button class="rectButton" style="background-color: ${displayMode === 'Image' ? '#3d79cc' : '#4d97ff'}; color: #ffffff" onclick="projectInfo.projectMeta.settings.defaultDisplay = 'Image'; saveToHistory(); highlightButton(this);">Image</button></div>
        </div>
        <div class="settingsSectionWrapper">
        <span class="hasTip" tip="Determines the input method for your program:\n • ASCII takes text and converts it into a number (Search for &#34ASCII table&#34 for conversions).\n • Number uses a numeric value directly input by the user.">Input mode</span>
        <div class="defaultInputType" style="grid: 1fr / repeat(2, 1fr);"><button class="rectButton" style="background-color: ${inputMode === 'ASCII' ? '#3d79cc' : '#4d97ff'}; color: #ffffff" onclick="projectInfo.projectMeta.settings.defaultInput = 'ASCII'; saveToHistory(); highlightButton(this);">ASCII</button><button class="rectButton" style="background-color: ${inputMode === 'Number' ? '#3d79cc' : '#4d97ff'}; color: #ffffff" onclick="projectInfo.projectMeta.settings.defaultInput = 'Number'; saveToHistory(); highlightButton(this);">Number</button></div>
        </div>
        <div class="settingsSectionWrapper">
        <span class="hasTip" tip="Optional setting to determine the maximum and minimum values of cells. 0 - 255 is reccomended.">Cell wrap</span>
        <div style="font-size: 16px">(Leave blank if you don't want wrap)</div>
        <div class="inputGrid">
        <span>Minimum value</span><input class="normalInput minCWVal" style="display: block; width: calc(100% - 5px)" type="text" placeholder="Number" oninput="this.value = this.value.replace(/\\D/g,''); projectInfo.projectMeta.settings.cellWrap[0] = this.value; saveToHistory()" value="${projectInfo.projectMeta.settings.cellWrap[0] ? projectInfo.projectMeta.settings.cellWrap[0] : ''}">
        <span>Maximum value</span><input class="normalInput maxCWVal" style="display: block; width: calc(100% - 5px)" type="text" placeholder="Number" oninput="this.value = this.value.replace(/\\D/g,''); projectInfo.projectMeta.settings.cellWrap[1] = this.value; saveToHistory()" value="${projectInfo.projectMeta.settings.cellWrap[1] ? projectInfo.projectMeta.settings.cellWrap[1] : ''}">
        </div>
        </div>
        <div class="settingsSectionWrapper">
        <span class="hasTip" tip="Allows preset values to be input automatically when the program is running.">Preset inputs</span>
        <textarea class="presetInputs" placeholder="Type or paste inputs here (Seperate with line breaks, use only numbers)" oninput="this.value = this.value.replaceAll(/[^\\d^\\n]/g, ''); projectInfo.projectMeta.settings.inputs = this.value.split('\\n'); projectInfo.projectMeta.settings.inputs = projectInfo.projectMeta.settings.inputs.filter(String); saveToHistory()">${projectInfo.projectMeta.settings.inputs.toString().replaceAll(',', '\n')}</textarea>
        </div>
        <div class="settingsSectionWrapper">
        Description
        <textarea class="description" placeholder="Write a description here" oninput="projectInfo.projectMeta.description = this.value; saveToHistory()">${projectInfo.projectMeta.description}</textarea>
        </div>
        <h1 class="sectionHeader" id="textView-export">Export</h1>
        <button class="rectButton" style="background-color: #4d97ff; color: #ffffff" onclick="popups.exportLS()">Export as Linear Scratch file<img height="27.5" style="height: 27.5px; width: min-content; padding: 0; float: right; margin: 0; transform: scale(0.9)" src="icons/Download.svg"></button>
        <button class="rectButton" style="background-color: #4d97ff; color: #ffffff" onclick="popups.exportBF()">Export as .BF<img height="27.5" style="height: 27.5px; width: min-content; padding: 0; float: right; margin: 0" src="icons/settings/Download_BF.svg"></button>
        <img src="LSimages/LS_logo.svg" alt="Linear Scratch logo" >
        </span>
        </div>
        <div class="whiteBG loading">Content loading</div>
        `)
        setTimeout(()=>{renderProjectManager()
        renderProjectHistory();
        if (storageAvailable()) renderUserProjects();
        [...document.getElementsByClassName("toggle")].forEach((el=>{toggleAutosaves(el, true)}));
        [...document.getElementsByClassName("resize")].forEach((el)=>{resizeCheck(el)})
        document.getElementsByClassName("loading")[0].remove()
        },1)
    }

    function toggleAutosaves(el, noToggle) {
        if(JSON.parse(localStorage.getItem("ls-settings")).autosave === "true") {
            if(!noToggle) {
                localStorage.setItem("ls-settings", JSON.stringify({
                    "autosave": "false",
                    "openProject": sessionInfo.saveTo
                }))
                el.classList.remove("ticked")
            } else {
                el.classList.add("ticked")
            }
        } else {
            if(!noToggle) {
                localStorage.setItem("ls-settings", JSON.stringify({
                    "autosave": "true",
                    "openProject": sessionInfo.saveTo
                }))
                el.classList.add("ticked")
            } else {
                el.classList.remove("ticked")
            }
        }
    }

    function renderSettingsInfo(){
        document.body.insertAdjacentHTML("beforeend", `<div class="whiteBG loading">Content loading</div>`)
        setTimeout(()=> {
            renderProjectHistory()
            renderProjectManager()
            renderUserProjects()
            playButtonCheck()
            saveToHistory()
            document.getElementsByClassName("description")[0].value = projectInfo.projectMeta.description
            document.getElementsByClassName("presetInputs")[0].value = projectInfo.projectMeta.settings.inputs
            document.getElementsByClassName("inputGrid")[0].children[1].value = projectInfo.projectMeta.settings.cellWrap[0] || 0
            document.getElementsByClassName("inputGrid")[0].children[3].value = projectInfo.projectMeta.settings.cellWrap[1] || 0
            highlightButton(document.getElementsByClassName("defaultInputType")[0].children[(projectInfo.projectMeta.settings.defaultInput === "ASCII") ? 0 : 1])
            highlightButton(document.getElementsByClassName("defaultDisplayType")[0].children[(projectInfo.projectMeta.settings.defaultDisplay === "ASCII") ? 0 : (projectInfo.projectMeta.settings.defaultDisplay === "Numeric") ? 1 : 2])
            document.getElementsByClassName("loading")[0].remove()
        },1)
    }

    function renderUserProjects(){
        const sidebarScrollPos = document.getElementsByClassName("settingsSideBar")[0].scrollTop
        const scrollPos = document.getElementsByClassName("userProjects")[0].scrollTop
        document.getElementsByClassName("userProjects")[0].innerHTML = ''
        let projects = JSON.parse(localStorage.getItem('ls-projectOrder'))
        if(document.getElementsByClassName("projectHistory")[0]){
            projects.forEach((i) => {
                document.getElementsByClassName("userProjects")[0].innerHTML += `<li style="position:relative;"><button style="max-width: calc(100% - 20px)" class="plainButton" onclick='sessionInfo = {closedWarnings: [],fullHistory:[],undoRedoHistory:[],undoRedoPos:0,saveTo:this.innerText}; localStorage.setItem("ls-settings", JSON.stringify({"autosave": JSON.parse(localStorage.getItem("ls-settings")).autosave,"openProject":this.innerText})); projectInfo = JSON.parse(localStorage.getItem("ls-projectStore"))["${i}"]; renderSettingsInfo(); saveToHistory();'></button><button style="float: right; width: min-content; height: 26.25px; display: inline-flex; align-items: center" class="plainButton hiddenUntilHovered" onclick="popups.editSaveSlot('${i}')"><img alt="Options" class="scriptOptionsButton" src="icons/Options_small.svg" width="14" style="transform: translate(0, 0)"></button></li>`;
                if(i === sessionInfo.saveTo) document.getElementsByClassName("userProjects")[0].lastElementChild.style.backgroundColor = "#d9e2ed";
                document.getElementsByClassName("userProjects")[0].children[document.getElementsByClassName("userProjects")[0].children.length-1].firstElementChild.innerText += i;
            })
            document.getElementsByClassName("userProjects")[0].innerHTML += `<li><button class="plainButton" style="color:#4d97ff;" onclick="popups.newSaveSlot()">Create new slot</button></li>`;
        }
        document.getElementsByClassName("userProjects")[0].scrollTop = scrollPos
        document.getElementsByClassName("settingsSideBar")[0].scrollTop = sidebarScrollPos
    }

    function renderProjectHistory(){
        if(document.getElementsByClassName("projectHistory")[0]){
            document.getElementsByClassName("projectHistory")[0].innerHTML = ''
            sessionInfo.fullHistory.forEach((i) => {
                if (JSON.stringify(i.data) === JSON.stringify(genProject())) document.getElementsByClassName("projectHistory")[0].innerHTML += `<li><button class="plainButton" onclick='treeRender(); projectInfo = ${JSON.stringify(JSON.parse(JSON.stringify(i.data)))}; saveToHistory(); if (editing !== "projectData.main") renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code,get(projectInfo, editing).loc); else renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code); saveToHistory(); renderProjectHistory(); addNameInput(); document.getElementsByClassName("whiteBG")[0].remove();'>${i.time.getHours()}:${i.time.getMinutes()}:${i.time.getSeconds()} - <span style="color: #ff0000">Blank</button></li>`;
                else document.getElementsByClassName("projectHistory")[0].innerHTML += `<li><button class="plainButton" onclick='treeRender(); projectInfo = ${JSON.stringify(JSON.parse(JSON.stringify(i.data)))}; saveToHistory(); if (editing !== "projectData.main") renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code,get(projectInfo, editing).loc); else renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code); saveToHistory(); renderProjectHistory(); addNameInput(); document.getElementsByClassName("whiteBG")[0].remove()'>${i.time.getHours()}:${i.time.getMinutes()}:${i.time.getSeconds()}</button></li>`
            })
        }
    }

    function renderProjectManager(){
        if(document.getElementsByClassName("projectManager")[0]) {
            document.getElementsByClassName("projectManager")[0].innerHTML = `
        Scripts: <div class="infoContainer"><button class="plainButton" onclick="popups.editScript('projectData.main', true)">"${projectInfo.projectData.main.name}" <span style="color:#ff0000;">No icon</span></button><br></div>
        <h3><button class="plainButton" onclick="popups.editExtension('projectData.custom')">Custom blocks</button></h3>
        Color: <div class="infoContainer"><span style="color: #ff6680">#ff6680</span></div><br>
        Script count: <div class="infoContainer">${projectInfo.projectData.custom.scripts.length}</div><br>
        Scripts: <div class="infoContainer CBscripts"></div>
        <div class="projectExtensions"></div>`
            if (projectInfo.projectData.custom.scripts.length > 0) {
                projectInfo.projectData.custom.scripts.forEach((i) => {
                    document.getElementsByClassName("CBscripts")[0].innerHTML += `<button class="plainButton" onclick="popups.editScript('projectData.scripts.${i}', true)">"${projectInfo.projectData.scripts[i].name}" ${projectInfo.projectData.scripts[i].icon === "" ? `<span style="color:#ff0000;">No icon</span>` : `("${projectInfo.projectData.scripts[i].icon}")`}</button><br>`
                })
            } else {
                document.getElementsByClassName("CBscripts")[0].innerHTML += `<span style="color:#ff0000;">None</span>`
            }
            Object.keys(projectInfo.projectData.extensions).forEach((ti) => {
                document.getElementsByClassName("projectExtensions")[0].innerHTML += `<h3><button class="plainButton" onclick="popups.editExtension('projectData.extensions.${ti}')">${projectInfo.projectData.extensions[ti].name}</button></h3>
            Color: <div class="infoContainer"><span style="color: ${projectInfo.projectData.extensions[ti].color}">${projectInfo.projectData.extensions[ti].color}</span></div><br>
            Script count: <div class="infoContainer">${projectInfo.projectData.extensions[ti].scripts.length}</div><br>
            Scripts: <div class="infoContainer"></div>
            `
                if (projectInfo.projectData.extensions[ti].scripts.length > 0) {
                    projectInfo.projectData.extensions[ti].scripts.forEach((i) => {
                        document.getElementsByClassName("projectExtensions")[0].lastElementChild.innerHTML += `<button class="plainButton" onclick="popups.editScript('projectData.scripts.${i}', true)">"${projectInfo.projectData.scripts[i].name}" ${projectInfo.projectData.scripts[i].icon === "" ? `<span style="color:#ff0000;">No icon</span>` : `("${projectInfo.projectData.scripts[i].icon}")`}</button><br>`
                    })
                } else {
                    document.getElementsByClassName("projectExtensions")[0].innerHTML += `<span style="color:#ff0000;">None</span>`
                }
            })
        }
    }

    function accScripts(ids){
        let acc = []
        ids.forEach((i)=>{
            delete projectInfo.projectData.scripts[i].loc
            acc.push(projectInfo.projectData.scripts[i])
        })
        return acc
    }

    window.addEventListener("load",()=> {
        if (storageAvailable()) {
            if (localStorage.getItem("ls-projectStore") === null) {
                projectInfo.projectMeta.name = "My Project 1"
                localStorage.setItem("ls-projectStore", `{"My Project 1": ${JSON.stringify(projectInfo)}}`)
                localStorage.setItem("ls-projectOrder", '["My Project 1"]')
                localStorage.setItem("ls-sessionCounter", "1")
                sessionInfo.saveTo = "My Project 1"
                localStorage.setItem("ls-settings", JSON.stringify({
                    "autosave": "false",
                    "openProject": "My Project 1"
                }))
                document.getElementsByClassName("name")[0].value = "My Project 1"
            } else {
                if (JSON.parse(localStorage.getItem("ls-settings")).autosave === "true") {
                    let store = JSON.parse(localStorage.getItem("ls-projectStore"))
                    localStorage.setItem("ls-sessionCounter", (parseInt(localStorage.getItem("ls-sessionCounter")) + 1).toString())
                    projectInfo.projectMeta.name = "My Project " + localStorage.getItem("ls-sessionCounter")
                    store["My Project " + localStorage.getItem("ls-sessionCounter")] = projectInfo
                    localStorage.setItem("ls-projectStore", JSON.stringify(store))
                    sessionInfo.saveTo = "My Project " + localStorage.getItem("ls-sessionCounter")
                    let list = JSON.parse(localStorage.getItem("ls-projectOrder"))
                    list.push("My Project " + localStorage.getItem("ls-sessionCounter"))
                    localStorage.setItem("ls-projectOrder", JSON.stringify(list))
                    document.getElementsByClassName("name")[0].value = "My Project " + localStorage.getItem("ls-sessionCounter")
                    console.log("Autosaves active")
                } else {
                    sessionInfo.saveTo = JSON.parse(localStorage.getItem("ls-settings")).openProject
                    projectInfo = JSON.parse(localStorage.getItem("ls-projectStore"))[sessionInfo.saveTo]
                    treeRender();
                    if (editing !== 'projectData.main') renderScript(get(projectInfo, editing).name, get(projectInfo, editing).code, get(projectInfo, editing).loc);
                    else renderScript(get(projectInfo, editing).name, get(projectInfo, editing).code)
                    resizeCheck(document.getElementsByClassName('scriptName')[0])
                    document.getElementsByClassName("name")[0].value = JSON.parse(localStorage.getItem("ls-projectStore"))[JSON.parse(localStorage.getItem("ls-settings")).openProject].projectMeta.name
                }
            }
        } else {
            renderWarning("Your browser does not have a functioning localStorage API. Your projects cannot autosave.")
            projectInfo.projectMeta.name = "My Project"
                window.addEventListener("beforeunload",(ev)=>{
                ev.preventDefault();
                return (ev.returnValue = "");
            })
        }
        new ResizeObserver(doResizePattern).observe(document.getElementsByClassName("scriptWrapperOuter")[0]);
        new ResizeObserver(doResizePattern).observe(document.body);
        playButtonCheck()
        saveToHistory()
        document.addEventListener("keydown", historyChecks)
        function historyChecks(ev) {
            if (navigator.appVersion.indexOf("Mac") !== -1){
                if (ev.metaKey && String.fromCharCode(ev.keyCode) === "Z"){
                    if (ev.shiftKey) loadUndoRedo(true);
                    else loadUndoRedo(false)
                    ev.preventDefault()
                }
            } else if (ev.ctrlKey && String.fromCharCode(ev.keyCode) === "Z"){
                if (ev.shiftKey) loadUndoRedo(true);
                else loadUndoRedo(false)
                ev.preventDefault()
            }
        }
        renderHelp()
        document.getElementsByClassName("beforeLoad")[0].remove()
    })

    function playButtonCheck() {
        const playButton = document.getElementsByClassName("playButton")[0]
        if(projectInfo.projectData.main.code.length>0){
            playButton.style.display = "inline-block"
            if(!doFullErrorsCheck()){
                playButton.style.color = "#ff6666"
                playButton.style.setProperty("--button-icon", "'!'")
                playButton.style.setProperty("--button-content", "'Error'")
                playButton.removeEventListener("click", renderDebug)
            }else{
                playButton.style.color = ""
                playButton.style.setProperty("--button-icon", "url('icons/Play.svg')")
                playButton.style.setProperty("--button-content", "'Play'")
                playButton.addEventListener("click", renderDebug)
            }
        }else{
            playButton.style.display = "none"
        }
    }

    function expandMenuBlock(el) {
        const measurements = document.getElementsByClassName("measurements")[0]
        const clonedEl = el.cloneNode(true)
        measurements.innerHTML = ""
        measurements.appendChild(clonedEl)
        measurements.children[0].style.height = "max-content"
        el.style.height = measurements.getBoundingClientRect().height + "px"
        measurements.innerHTML = ""
    }

    function loadPremadeExtension(ex) {
        let code
        if (ex === "HW") code = {"color":"#c366ff","name":"Hello world!","scripts":[{"icon":"`","name":"Hello world!","code":"‡+‡+‡+‡+‡+‡+‡+‡+‡[‡>‡+‡+‡+‡+‡[‡>‡+‡+‡>‡+‡+‡+‡>‡+‡+‡+‡>‡+‡<‡<‡<‡<‡-‡]‡>‡+‡>‡+‡>‡-‡>‡>‡+‡[‡<‡]‡<‡-‡]‡>‡>‡.‡>‡-‡-‡-‡.‡+‡+‡+‡+‡+‡+‡+‡.‡.‡+‡+‡+‡.‡>‡>‡.‡<‡-‡.‡<‡.‡+‡+‡+‡.‡-‡-‡-‡-‡-‡-‡.‡-‡-‡-‡-‡-‡-‡-‡-‡.‡>‡>‡+‡."},{"icon":"+","name":"Add cells","code":"‡[‡-‡<‡+‡>‡]"},{"icon":"-","name":"Subtract cells","code":"‡[‡-‡<‡-‡>‡]"}]};
        else if (ex === "copy") code = {"color":"#6163f0","name":"Copy blocks","scripts":[{"icon":"(","name":"Copy cell left","code":"‡[‡-‡<‡+‡<‡+‡>‡>‡]‡<‡<‡[‡-‡>‡>‡+‡<‡<‡]‡>"},{"icon":")","name":"Copy cell right","code":"‡[‡-‡>‡+‡>‡+‡<‡<‡]‡>‡>‡[‡-‡<‡<‡+‡>‡>‡]‡<"}]};
        else if (ex === "clear") code = {"color":"#fff353","name":"Clear cells","scripts":[{"icon":"v","name":"Clear down","code":"‡[‡-‡]"},{"icon":"^","name":"Clear up","code":"‡[‡+‡]"}]};
        let loadedEx = createExtension(code.name, code.color)
        code.scripts.forEach((i)=>{
            createScript("projectData.extensions." + loadedEx,i.name,i.icon,i.code)
        })
        renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code);
        treeRender()
    }

    let mouse = {}

    function renderLinkTip(el, attr) {
        const oldTip = document.getElementsByClassName("tooltip")[0]
        const tip = el.getAttribute(attr)
        if(!oldTip || (tip !== document.getElementsByClassName("tooltip")[0].innerText)) {
            const tipEl = document.createElement("span")
            tipEl.classList.add("tooltip")
            if (oldTip) {
                [...document.getElementsByClassName("tooltip")].forEach((el) => {
                    el.remove()
                })
            }
            // tipEl.style.top = el.getBoundingClientRect().y+el.getBoundingClientRect().height + "px"
            // tipEl.style.left = el.getBoundingClientRect().x + "px"
            document.body.appendChild(tipEl)
            tipEl.innerText = tip
            setTimeout(() => {
                tipEl.style.opacity = "1"
                tipEl.style.left = "0"
                if(tipEl.getBoundingClientRect().width + mouse.x > window.innerWidth - 5) {
                    tipEl.style.left = (window.innerWidth - 10 - tipEl.getBoundingClientRect().width) + "px"
                } else {
                    tipEl.style.left = mouse.x + 10 + "px"
                }
                if (tipEl.getBoundingClientRect().height + mouse.y > window.innerHeight - 5) {
                    tipEl.style.top = (window.innerHeight - 10 - tipEl.getBoundingClientRect().height) + "px"
                } else {
                    tipEl.style.top = mouse.y + 10 + "px"
                }
            }, oldTip ? 0 : 500)

            function deleteTip() {
                tipEl.style.opacity = "0"
                setTimeout(() => {
                    tipEl.remove()
                }, 150)
                el.removeEventListener("mouseleave", deleteTip)
            }

            el.addEventListener("mouseleave", deleteTip)
            document.addEventListener("click", () => {
                deleteTip()
            })
        }
    }

        document.addEventListener("mousemove", (ev)=>{
        mouse.x = ev.x;
        mouse.y = ev.y;
        [...document.getElementsByTagName("a")].forEach((el)=>{
            el.removeEventListener("mouseenter",()=> {
                renderLinkTip(el, "href")
            })
        });
        [...document.getElementsByTagName("a")].forEach((el)=>{
            el.addEventListener("mouseenter",()=> {
                renderLinkTip(el, "href")
            })
        });
        [...document.getElementsByClassName("hasTip")].forEach((el)=>{
            el.removeEventListener("mouseenter",()=> {
                renderLinkTip(el, "tip")
            })
        });
        [...document.getElementsByClassName("hasTip")].forEach((el)=>{
            el.addEventListener("mouseenter",()=> {
                renderLinkTip(el, "tip")
            })
        })
    })

    function renderTurboInPlayer() {
        if (!interpreterInfo.turbo) {
            const turboButton = document.getElementsByClassName("turboButton")[0]
            turboButton.insertAdjacentHTML("afterend",`<button style="float: right" class="plainButton hasTip projectControl turboButton" tip="Turbo mode" onmouseover="this.children[0].src = 'icons/Turbo_off_dark_blue.svg'" onmouseout="this.children[0].src = 'icons/Turbo_off_blue.svg'" onclick="interpreterInfo.turbo = !interpreterInfo.turbo; renderTurboInPlayer()"><img height="20" width="20" src="icons/Turbo_off_blue.svg"></button>`)
            turboButton.remove()
        } else {
            const turboButton = document.getElementsByClassName("turboButton")[0]
            turboButton.insertAdjacentHTML("afterend",`<button style="float: right" class="plainButton hasTip projectControl turboButton" tip="Turbo mode" onclick="interpreterInfo.turbo = !interpreterInfo.turbo; renderTurboInPlayer(this)"><img height="20" width="20" src="icons/Turbo_on.svg"></button>`)
            turboButton.remove()
        }
    }

    function testForValidInput(inputType, value){
        if (inputType === "ASCII"){
            return /^[\u0000-\u007f]$/.test(value);
        } else if(inputType === "Number"){
            return /^-*\d+$/.test(value);
        }
    }

    function renderPlayer() {
        openViewTS();
        function revertControls() {
            document.getElementsByClassName("projectControls")[0].children[0].innerHTML = `
        <span><button class="plainButton hasTip projectControl startButton" tip="Play" onclick="runProgram()"><img height="20" src="icons/Play.svg"></button>
        </span>`
        }
        document.addEventListener("programEnd",revertControls)
        runProgram(true);
        [...document.getElementsByClassName("block")].forEach((el)=>{
            el.remove()
        })
        if(document.getElementsByClassName("scriptName")[0])document.getElementsByClassName("scriptName")[0].remove()
        const displayMode = projectInfo.projectMeta.settings.defaultDisplay
        const inputMode = projectInfo.projectMeta.settings.defaultInput
        document.body.insertAdjacentHTML('beforeend',`
        <div class="whiteBG playerIdentifier">
        <button class="roundButton closeView" style="--button-icon: url('icons/Close_blue.svg'); --button-content: 'Close'; position:fixed; top: 5px; left: 5px;" onclick="closeViewTS(); interpreterInfo.paused = true; addNameInput(); treeRender(); renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code); resizeCheck(document.getElementsByClassName('scriptName')[0]); this.parentElement.remove()"></button>
        <div class="viewTitle">Project player</div>
        <span class="viewSideBar"><h1 style="text-align: center" class="sectionHeader">${projectInfo.projectMeta.name}</h1><div style="height: 1px; background: #000000; margin-bottom: 10px"></div>${projectInfo.projectMeta.description}</span>
        <span class="projectWrapper"><span class="projectControls"><button class="plainButton hasTip projectControl startButton" tip="Play" onclick="runProgram()"><img height="20" src="icons/Play.svg"></button><button style="float: right" class="plainButton hasTip projectControl turboButton" tip="Turbo mode" onmouseover="this.children[0].src = 'icons/Turbo_off_dark_blue.svg'" onmouseout="this.children[0].src = 'icons/Turbo_off_blue.svg'" onclick="interpreterInfo.turbo = !interpreterInfo.turbo; renderTurboInPlayer(this)"><img height="20" width="20" src="icons/Turbo_off_blue.svg"></button></span><span class="projectViewer"></span></span>
        </div>
        `)
        document.getElementsByClassName("projectViewer")[0].innerHTML = `<div class="projectContentWrapper">${(displayMode === "Image") ? '<canvas class="playerContent" width="480" height="274"></canvas>' : '<div class="playerContent"></div>'}</div><div class="inputMenu"><span class="inputsHolder"><input onkeydown="if(event.keyCode === 13) submitInput()" oninput="if(!testForValidInput('${inputMode}',this.value) && this.value.length > 0) this.style.background = '#ff9191'; else this.style.background = '#ffffff'" placeholder="Type input here... (${projectInfo.projectMeta.settings.defaultInput}, at least 1 character)"><button onclick="submitInput()">Submit</button></span></div>`
        document.getElementsByClassName("closeView")[0].addEventListener("click",()=>{
            document.removeEventListener("programEnd",revertControls)
        })
    }

    function submitInput() {
        if(testForValidInput(projectInfo.projectMeta.settings.defaultInput,document.getElementsByClassName("inputsHolder")[0].children[0].value) && interpreterInfo.requestInput){
            runningInfo.inputs.push(document.getElementsByClassName("inputsHolder")[0].children[0].value);
            pushInput();
            interpreterInfo.requestInput = false
            document.getElementsByClassName("inputsHolder")[0].children[0].value = '';
            if(document.getElementsByClassName('inputPrompt')[0]) document.getElementsByClassName("inputPrompt")[0].remove()
            if(interpreterInfo.paused === false) {
                if (runningInfo.stackInfo.length > 1) runCustomBlock(JSON.stringify(interpreterInfo.requestInput));
                else interpretNext(true);
            }
        }
    }

    function runProgram(noStart) {
        initialise(projectInfo.projectData.main.code, projectInfo.projectMeta.settings.inputs, projectInfo.projectMeta.settings.cellWrap, projectInfo.projectMeta.settings.defaultInput, document.getElementsByClassName('mBSelected')[0] ? document.getElementsByClassName('mBSelected')[0].textContent : projectInfo.projectMeta.settings.defaultDisplay);
        interpreterInfo.paused = false;
        if(!noStart)startProgram();
        else interpreterInfo.turbo = false
    }

    function openViewTS(){
        [...document.querySelectorAll("input, button, textarea")].forEach((el)=>{
            if(el.getAttribute("tabIndex")){
                el.setAttribute("oldTabIndex0",el.getAttribute("tabIndex"))
            }
            el.classList.add("tabSuppressed0")
            el.setAttribute("tabIndex","-1")
        })
    }

    function closeViewTS() {
        [...document.querySelectorAll(".tabSuppressed0")].forEach((el)=>{
            if(el.getAttribute("oldTabIndex0")){
                if(!el.getAttribute("oldTabIndex1"))el.setAttribute("tabIndex",el.getAttribute("oldTabIndex0"))
                el.removeAttribute("oldTabIndex0")
            } else {
                if(!el.getAttribute("oldTabIndex1"))el.removeAttribute("tabIndex")
            }
            el.classList.remove("tabSuppressed0")
        })
    }

    function renderHelp() {
        openViewTS();
        function revertControls() {
            document.getElementsByClassName("projectControls")[0].children[0].innerHTML = `
        <span><button class="plainButton hasTip projectControl startButton" tip="Play" onclick="runProgram()"><img height="20" src="icons/Play.svg"></button>
        </span>`
        }
        document.addEventListener("programEnd",revertControls)
        runProgram(true);
        [...document.getElementsByClassName("block")].forEach((el)=>{
            el.remove()
        })
        if(document.getElementsByClassName("scriptName")[0])document.getElementsByClassName("scriptName")[0].remove()
        document.body.insertAdjacentHTML('beforeend',`
        <div class="whiteBG helpIdentifier">
        <button class="roundButton closeView" style="--button-icon: url('icons/Close_blue.svg'); --button-content: 'Close'; position:fixed; top: 5px; left: 5px;" onclick="closeViewTS(); interpreterInfo.paused = true; addNameInput(); treeRender(); renderScript(get(projectInfo, editing).name,get(projectInfo, editing).code); resizeCheck(document.getElementsByClassName('scriptName')[0]); this.parentElement.remove()"></button>
        <div class="viewTitle">How to use</div>
        <span class="viewSideBar">Linear Scratch is a programming language based off an esoteric programming language created by Urban Müller in 1993. The original language did not support functions, extensions, and other such features, although this compiles code into the original language as it runs. :D</span>
        <span class="helpContent" style="right: 0; width: calc(100% - min(30vw, 300px) - 10px);">
        <h1 class="sectionHeader">Language concepts</h1>
        <span class="helpSection" style="font-size: 16px">LS uses an infinitely long array to store information. The array is made up of cells, each containing an individual value. It can be navigated using a pointer.</span>
        <h1 class="sectionHeader">Syntax</h1>
        <span class="helpSection" style="font-size: 16px; font-family: Monospaced, monospace; white-space: pre">• '>' Move pointer to next position.
• '<' Move pointer to previous position.
• '+' Increase value of cell at pointer position by 1.
• '-' Decrease value of cell at pointer position by 1.
• '.' Return value of cell at pointer position to the output array.
• ',' Set value of cell at pointer position to user input.
• '[' If value of cell at pointer position is 0 skip all code until after next ']' that does not have a closer corresponding '['.
• ']' If value of cell is not 0 return to last '[' that does not have a closer corresponding ']'.</span>
        <h1 class="sectionHeader">Links</h1>
        <span class="helpSection" style="font-size: 16px;"><a href="https://web.alfredstate.edu/faculty/weimandn/miscellaneous/ascii/ascii_index.html">ASCII conversion table</a></span>
        <img src="LSimages/LS_logo.svg" alt="Linear Scratch logo" >
        </span>
        </div>
        `)
    }
</script>
</body>
</html>